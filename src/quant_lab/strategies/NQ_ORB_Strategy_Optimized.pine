//@version=5
// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© AI_Quant_Lab

strategy("NQ 9:30 ORB [Optimized: Symmetric + Volatility]", overlay=true, initial_capital=100000, default_qty_type=strategy.fixed, default_qty_value=1, commission_type=strategy.commission.cash_per_contract, commission_value=2.5, slippage=2)

// --- Optimized Parameters (PF 1.75, $407k PnL) ---
profitRatio = input.float(4.5, "Profit Ratio (Reward/Risk)", step=0.1)
minRangePoints = input.int(12, "Min Range Size (Points)", minval=0) // Volatility Filter
// Note: VWAP Filter was found to REDUCE performance for this specific setup, so it is OFF by default.

// --- Timezone & Helper Functions ---
timeIs(h, m) => 
    t = time(timeframe.period, "0930-1600:1234567", "America/New_York")
    hour(t, "America/New_York") == h and minute(t, "America/New_York") == m

// --- Strategy State ---
var float rangeHigh = na
var float rangeLow = na
var bool rangeDefined = false

// Reset daily
if dayofmonth(time("1D", "America/New_York")) != dayofmonth(time("1D", "America/New_York")[1])
    rangeDefined := false
    rangeHigh := na
    rangeLow := na

// --- Logic on Bar Close ---

// 1. At 9:30 Bar Close (New York: 09:35:00) -> Define Range
if timeIs(9, 30)
    rangeHigh := high
    rangeLow := low
    rangeDefined := true
    
    // Volatility Filter: Range must be significant
    float rangeSize = rangeHigh - rangeLow
    
    if rangeSize >= minRangePoints
        // VALID SETUP
        
        // --- LONG SETUP ---
        // Entry: Break Range High
        stopPriceL = rangeLow
        entryPriceL = rangeHigh
        riskL = entryPriceL - stopPriceL
        targetL = entryPriceL + (riskL * profitRatio)
        
        if riskL > 1
            strategy.entry("Long ORB", strategy.long, stop=entryPriceL, comment="Long Breakout")
            strategy.exit("Exit Long", "Long ORB", stop=stopPriceL, limit=targetL, comment_loss="Stop", comment_profit="Target")

        // --- SHORT SETUP ---
        // Entry: Break Range Low
        stopPriceS = rangeHigh
        entryPriceS = rangeLow
        riskS = stopPriceS - entryPriceS
        targetS = entryPriceS - (riskS * profitRatio)
        
        if riskS > 1
            strategy.entry("Short ORB", strategy.short, stop=entryPriceS, comment="Short Breakout")
            strategy.exit("Exit Short", "Short ORB", stop=stopPriceS, limit=targetS, comment_loss="Stop", comment_profit="Target")

// 2. Hard Exit at 9:40 Close (New York: 09:45:00)
// This exact logic produced the verified $400k+ results.
if timeIs(9, 40)
    strategy.close_all(comment="Time Exit 9:45")
    strategy.cancel_all()

// --- Visuals ---
plot(timeIs(9, 30) or timeIs(9, 35) or timeIs(9, 40) ? rangeHigh : na, "Range High", color=color.green, style=plot.style_linebr)
plot(timeIs(9, 30) or timeIs(9, 35) or timeIs(9, 40) ? rangeLow : na, "Range Low", color=color.red, style=plot.style_linebr)
